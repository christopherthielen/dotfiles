#!/bin/bash
# Post-installation tasks

set -e

{{- if eq .chezmoi.os "darwin" }}
# asimov excludes node_modules, etc from Time Machine
if command -v brew &>/dev/null && brew services list | grep -q "^asimov *stopped"; then
    echo "Starting asimov service..."
    sudo brew services start asimov
fi
{{- end }}

# Configure git-lfs
if command -v git-lfs &>/dev/null; then
    echo "Configuring git-lfs..."
    git lfs install 2>/dev/null || true
fi

# Sync kickstart.nvim with upstream
KICKSTART_REPO="$HOME/.kickstart.nvim"
if [[ -d "$KICKSTART_REPO/.git" ]]; then
    echo "Syncing kickstart.nvim with upstream..."
    pushd "$KICKSTART_REPO" > /dev/null
    git remote add upstream https://github.com/nvim-lua/kickstart.nvim.git 2>/dev/null || true
    git fetch upstream 2>/dev/null || true
    git pull --rebase 2>/dev/null || true
    popd > /dev/null
fi

# Sync nvim plugins (retry a few times as nvim may have just been installed)
if command -v nvim &>/dev/null && [[ -d "$KICKSTART_REPO" ]]; then
    echo "Syncing nvim plugins (this may take a moment)..."
    nvim --headless "+Lazy! sync" +qa || echo "Note: nvim plugin sync failed, run ':Lazy sync' manually"
fi

echo "Post-install tasks complete!"

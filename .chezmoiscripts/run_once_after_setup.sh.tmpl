#!/bin/bash
# One-time setup tasks (runs once per machine)

set -e

# Ensure Homebrew is in PATH
{{- if eq .chezmoi.os "darwin" }}
if [[ -x /opt/homebrew/bin/brew ]]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
elif [[ -x /usr/local/bin/brew ]]; then
    eval "$(/usr/local/bin/brew shellenv)"
fi
{{- else }}
if [[ -x /home/linuxbrew/.linuxbrew/bin/brew ]]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi
{{- end }}

# Configure git-lfs
if command -v git-lfs &>/dev/null; then
    echo "Configuring git-lfs..."
    git lfs install 2>/dev/null || true
fi

# Initialize neovim
if command -v nvim &>/dev/null; then
    # Add AstroNvim upstream remote for template updates
    if [[ -d ~/.config/nvim/.git ]]; then
        git -C ~/.config/nvim fetch upstream 2>/dev/null || \
            git -C ~/.config/nvim remote add upstream https://github.com/AstroNvim/template.git
    fi

    echo "Initializing AstroNvim plugins..."
    nvim --headless "+Lazy! sync" +qa 2>/dev/null || true

    if [[ -d ~/.config/nvim-kickstart ]]; then
        echo "Initializing kickstart plugins..."
        NVIM_APPNAME=nvim-kickstart nvim --headless "+Lazy! sync" +qa 2>/dev/null || true
    fi

    # Set marker so nvim-update reminder doesn't fire immediately
    mkdir -p ~/.local/state
    touch ~/.local/state/nvim-updated
fi

echo "One-time setup complete!"
